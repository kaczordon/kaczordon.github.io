<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta property="og:image" content="https://imgflip.com/i/46zmti" />
    <meta property="og:title" content="Max Allman reviews film(Formerly known as Max Patrick)" />
    <script src="https://baloise-ui-library.now.sh/build/ui-library.js"></script>
    <link rel="stylesheet" href="https://baloise-ui-library.now.sh/build/ui-library.css" />
    <title>Formerly known as Max Patrick</title>
  </head>
  <body class="bal-app is-padded">
    <h2 class="title is-2 has-text-centered is-capitalized">Reviews by Max</h2>
<figure class="image">
  <image src="https://images.squarespace-cdn.com/content/v1/544057eee4b0c5dff23f0ef8/1511993287491-3RJRWLLL6MFYKDKBSBNN/ke17ZwdGBToddI8pDm48kKCnXnwcT0QUitMSaEmlBC8UqsxRUqqbr1mOJYKfIPR7LoDQ9mXPOjoJoqy81S2I8N_N4V1vUb5AoIIIbLZhVYxCRW4BPu10St3TBAUQYVKccQe5gdPbwQPtLp__r0ZV0dwj60L-U7OGk5ScHAAbu9Se_2Gi5szV2fm9tsEvKebY/YUR+_+Max+Allman+_+Photo.jpg"/>
</figure>
<h2 class="subtitle">The reviewer in his element.</h2>
<div class="bal-track-line is-padded"></div>
<div class="reviews my-6">
  <bal-spinner></bal-spinner>
</div>
  <script type="module">
    // import * as pkg from 'https://cdn.pika.dev/bal-ui-library@^1.24.0';
    // import * as cheerio from 'https://cdn.pika.dev/cheerio@^1.0.0-rc.3';
    // import * as htmlparser2 from 'https://cdn.pika.dev/htmlparser2@^4.1.0';
    // const parser = new htmlparser2.Parser();
  function isListItem (element) {
    // if the list path is in the url
    if (getUri(element).indexOf('/list/') !== -1) {
      return true;
    }

    return false;
}

function getPublishedDate (element) {
  return +new Date(element.querySelector('pubDate').innerHTML);
}

function getWatchedDate (element) {
  return +new Date(element.querySelector('watchedDate').innerHTML);
}

function getUri (element) {
  return element.querySelector('link').innerHTML;
}

function getTitleData (element) {
  return element.querySelector('title').innerHTML;
}

function getSpoilers (element) {
  var titleData = getTitleData(element);

  var containsSpoilersString = '(contains spoilers)';
  return (titleData.indexOf(containsSpoilersString) !== -1);
}

function getRating (element) {
  var titleData = getTitleData(element);
  var spoilers = getSpoilers(element);

  var rating = {
    text: 'None'
  };

  var ratingStringPosition = titleData.lastIndexOf('-');

  // if there is no '-' character there is no rating
  if (ratingStringPosition !== -1) {
    var endPosition = titleData.length;
    if (spoilers) {
      var containsSpoilersString = '(contains spoilers)';
      endPosition = endPosition - containsSpoilersString.length - 1;
    }
    rating.text = titleData.substring(ratingStringPosition + 2, endPosition);
  }

  // give a number score for the text that matches
  var score2Text = {
    'None': -1.0,
    '½': 0.5,
    '★': 1.0,
    '★½': 1.5,
    '★★': 2.0,
    '★★½': 2.5,
    '★★★': 3.0,
    '★★★½': 3.5,
    '★★★★': 4.0,
    '★★★★½': 4.5,
    '★★★★★': 5.0
  };
  rating.score = score2Text[rating.text];
  rating.text = rating.text;

  return rating;
}

function getTitleYearData (element) {
  var titleData = getTitleData(element);
  var rating = getRating(element);
  var ratingStringPosition = titleData.lastIndexOf('-');

  // if there is no rating titleAndYear is the whole string
  if (typeof rating.score === 'undefined' || rating.score === -1) {
    return titleData;
  } else {
    return titleData.substring(0, ratingStringPosition - 1);
  }
}

function getTitle (element) {
  var titleData = getTitleData(element);
  var titleAndYear = getTitleYearData(element);
  var lastComma = titleAndYear.lastIndexOf(',');
  return titleData.substring(0, lastComma);
}

function getYear (element) {
  var titleData = getTitleData(element);
  var titleAndYear = getTitleYearData(element);
  var lastComma = titleAndYear.lastIndexOf(',');
  return titleData.substring(lastComma + 2, titleAndYear.length);
}

function getImage (element) {
  var description = element.querySelector('description');
  // var $ = cheerio.load(description);
  var s = description.innerHTML;
  // find the film poster and grab it's src
  var image = s.substring(s.indexOf('https'), s.indexOf('"/'));

  // if the film has no image return no object
  if (!image) {
    return false;
  }

  return {
    tiny: image.replace('-0-150-0-225-crop', '-0-35-0-50-crop'),
    small: image.replace('-0-150-0-225-crop', '-0-70-0-105-crop'),
    medium: image,
    large: image.replace('-0-150-0-225-crop', '-0-230-0-345-crop')
  };
}

function getReview (element) {
  var description = element.querySelector('description');
  // var $ = cheerio.load(description);

  var s = description.innerHTML;
  // find the film poster and grab it's src
  var reviewParagraphs = s.substring(s.indexOf('</p> <p>') + 8, s.indexOf('</p> ]]>'));

  // if there is no review return the item
  if (reviewParagraphs.length <= 0) {
    return false;
  }

  // the rest of description is a review, if there is no review the string 'Watched on ' will appear
  // this assumes you didn't write the 'Watched on ' string in your review... weak
  if (reviewParagraphs.indexOf('Watched on ') !== -1) {
    return false;
  }
 return reviewParagraphs;
  var review = '';

  // loop through paragraphs
  reviewParagraphs.forEach(function () {
    var reviewParagraph = $(this).text();

    // only add paragaphs that are the review
    if (reviewParagraph !== 'This review may contain spoilers.') {
      review += reviewParagraph + '\n';
    }
  });

  // tidy up and add review to the item
  review = review.trim();

  return review;
}

function getListFilms (element) {
  var description = element.querySelector('description');
  // var $ = cheerio.load(description);

  var films = [];
  description.querySelector('li a').forEach(function (filmElement, i) {
    films.push({
      title: filmElement.innerHTML,
      uri: filmElement.getAttribute('href')
    });
  });
  return films;
}

function getListDescription (element) {
  var description = element.querySelector('description');
  // var $ = cheerio.load(description);

  var result = false;

  // if there are no paragraphs in the description there isnt one
  if (description.querySelector('p').length <= 0) {
    return result;
  }

  description.querySelector.forEach(function (element, i) {
    // we'll assume descriptions dont have the link text in
    var text = element.innerHTML;
    var isntPlusMoreParagraph = text.indexOf('View the full list on Letterboxd') === -1;
    if (isntPlusMoreParagraph) {
      result = text;
    }
  });

  return result;
}

function getListTotalFilms (element) {
  var description = element.querySelector('description');
  // var $ = cheerio.load(description);

  var films = getListFilms(element);

  var result = films.length;

  // if there are no paragraphs in the description there isnt one
  if (description.querySelector('p').length <= 0) {
    return result;
  }

  description.querySelector('p').forEach(function (paragraphElement, i) {
    var text = $(paragraphElement).text();
    var isPlusMoreParagraph = text.indexOf('View the full list on Letterboxd') !== -1;
    if (isPlusMoreParagraph) {
      var startNumberPositionString = '...plus ';
      var startNumberPosition = text.indexOf(startNumberPositionString) + startNumberPositionString.length;

      var endNumberPositionString = ' more. View the full list on Letterboxd.';
      var endNumberPosition = text.indexOf(endNumberPositionString);

      var number = +text.substring(startNumberPosition, endNumberPosition);

      result += number;
    }
  });

  return result;
}

function isListRanked (element) {
  var description = element.querySelector('description');
  // var $ = cheerio.load(description);

  var isOrderedListPresent = !!description.querySelector('ol').length;
  return isOrderedListPresent;
}

function processItem (element) {
  // there are two types of items: lists and diary entries

  if (isListItem(element)) {
    // return a list
    return {type: 'list'}
    // return {
    //   type: 'list',
    //   date: {
    //     published: getPublishedDate(element)
    //   },
    //   title: getTitleData(element),
    //   description: getListDescription(element),
    //   ranked: isListRanked(element),
    //   films: getListFilms(element),
    //   totalFilms: getListTotalFilms(element),
    //   uri: getUri(element)
    // };
  }

  // otherwise return a diary entry
  return {
    type: 'diary',
    date: {
      published: getPublishedDate(element),
      watched: getWatchedDate(element)
    },
    film: {
      title: getTitle(element),
      year: getYear(element),
      image: getImage(element)
    },
    rating: getRating(element),
    review: getReview(element),
    spoilers: getSpoilers(element),
    uri: getUri(element)
  };
}

function invalidUsername (username) {
  return !username || username.trim().length <= 0;
}

function getDiaryData (username) {
  var uri = 'https://cors-anywhere.herokuapp.com/https://letterboxd.com/' + username + '/rss/';

  return new Promise(function (resolve, reject) {
    
    fetch(uri)
    .then(response => response.text())
    .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
    .then(data => {
      console.log(data);
      var elements = data.querySelectorAll('item');

      var items = [];
      var str = '';
      var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      var score2Text = {
        '½': 0.5,
        '★': 1.0,
        '★½': 1.5,
        '★★': 2.0,
        '★★½': 2.5,
        '★★★': 3.0,
        '★★★½': 3.5,
        '★★★★': 4.0,
        '★★★★½': 4.5,
        '★★★★★': 5.0
      };

      function randomNumber(min, max) {  
        return Math.random() * (max - min) + min; 
      }  
      elements.forEach(function (element, i) {
        var item = processItem(element);
        
        if (item && item.type !== 'list') {
          if(!item.review) {
            var t = 'hyuck ';
            item.review = t.repeat(randomNumber(1, 20))
          }
          if(!(item.rating.text in score2Text)) {
            item.rating.text = "too lazy to rate this one."
          }
          if(item.film.title.length > 30) item.film.title = item.film.title.slice(0, 30) + '...';
          var s = ''
          if(i == 0 || i % 3 == 1) s += '<div class="tile is-ancestor">'
          s += `<div class="tile is-parent"><bal-card class="my-3 tile is-child">`;
          s += `<bal-card-heading class="has-text-centered">${item.film.title}</bal-card-heading>`
          s += `<div class="columns is-mobile">
                  <div class="column">
                    <figure class="image is-128x128"><image src="${item.film.image.medium}" /></figure>
                  </div>`
          items[i] = item;
          var icon = n => `<bal-list-item-icon><bal-icon size="medium" name="${n}"></bal-icon></bal-list-item-icon>`
          s += `<div class="column"><bal-list class="box is-padded"><bal-list-item>${icon('info-circle')}<bal-list-item-content>${item.rating.text}</bal-list-item-content></bal-list-item>`
          s += `<bal-list-item>${icon('date')}<bal-list-item-content>${new Date(item.date.published).toLocaleDateString("en-US")}</bal-list-item-content></bal-list-item></bal-list></div></div>`
          // s += `<bal-icon class="alert" name="date" size="medium" isLeft><span class="is-size-6">hello</span></bal-icon></div></div>`
          // s += `<bal-card-subtitle>${item.film.title}</bal-card-subtitle>`
          s += `<bal-accordion open-label="See his review" close-label="close review"><p class="is-padded">${item.review}</p></bal-accordion>`
          s += '</bal-card></div>';
          if(i % 3 == 0) s += '</div>'
          str += s;
        }
        
      });
      document.querySelector('.reviews').innerHTML = str;
      return resolve(items);
      })
    .catch((error) => {
      console.error('Error:', error);
      return reject('Error:', error);
    });
  });
}

function main (username, callback) {
  // check if a valid username has been passed in
  if (invalidUsername(username)) {
    return;// callback('No username sent as a parameter');
  }

  return getDiaryData(username);//.asCallback(callback);
}
main('mpa10e')
  </script>
  </body>
</html>